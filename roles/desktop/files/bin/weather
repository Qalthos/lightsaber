#!/usr/bin/env python
from __future__ import annotations

import json
import sys

from datetime import datetime
from typing import TypedDict
from urllib.request import urlopen


ICON_MAP = {
    "113": "â˜€ï¸",
    "116": "â›…ï¸",
    "119": "â˜ï¸",
    "122": "â˜ï¸",
    "143": "ðŸŒ«",
    "176": "ðŸŒ¦",
    "179": "ðŸŒ§",
    "182": "ðŸŒ§",
    "185": "ðŸŒ§",
    "200": "â›ˆ",
    "227": "ðŸŒ¨",
    "230": "â„ï¸",
    "248": "ðŸŒ«",
    "260": "ðŸŒ«",
    "263": "ðŸŒ¦",
    "266": "ðŸŒ¦",
    "281": "ðŸŒ§",
    "284": "ðŸŒ§",
    "293": "ðŸŒ¦",
    "296": "ðŸŒ¦",
    "299": "ðŸŒ§",
    "302": "ðŸŒ§",
    "305": "ðŸŒ§",
    "308": "ðŸŒ§",
    "311": "ðŸŒ§",
    "314": "ðŸŒ§",
    "317": "ðŸŒ§",
    "320": "ðŸŒ¨",
    "323": "ðŸŒ¨",
    "326": "ðŸŒ¨",
    "329": "â„ï¸",
    "332": "â„ï¸",
    "335": "â„ï¸",
    "338": "â„ï¸",
    "350": "ðŸŒ§",
    "353": "ðŸŒ¦",
    "356": "ðŸŒ§",
    "359": "ðŸŒ§",
    "362": "ðŸŒ§",
    "365": "ðŸŒ§",
    "368": "ðŸŒ¨",
    "371": "â„ï¸",
    "374": "ðŸŒ§",
    "377": "ðŸŒ§",
    "386": "â›ˆ",
    "389": "ðŸŒ©",
    "392": "â›ˆ",
    "395": "â„ï¸",
}


def desc(status: WeatherDesc) -> str:
    return status["weatherDesc"][0]["value"]


def weather(location: str) -> str:
    url = f"https://wttr.in/{location}?format=j1"
    response = urlopen(url)
    w_data = json.loads(response.read())

    location_data = w_data["nearest_area"][0]
    location = f"{location_data['areaName'][0]['value']}, {location_data['region'][0]['value']}"

    condition = w_data["current_condition"][0]

    data: dict[str, str] = {}
    icon = condition["weatherCode"]
    icon = ICON_MAP.get(icon, icon)

    data["text"] = f"{icon} {condition['temp_C']} C"

    humid = condition["humidity"]
    wind = condition["windspeedMiles"]
    detail = (
        f"{location}\n{desc(condition)}\nHumidity: {humid}%\nWind Speed: {wind}mph\n"
    )

    forecast: list[str] = []
    for i, day in enumerate(w_data["weather"]):
        if i == 0:
            forecast.append("<b>Today</b>")
        elif i == 1:
            forecast.append("<b>Tomorrow</b>")
        else:
            forecast.append(f"<b>{day['date']}</b>")

        for hour in day["hourly"]:
            hour_int = int(hour["time"]) // 100
            if i == 0 and hour_int <= datetime.now().hour:
                continue

            icon = hour["weatherCode"]
            icon = ICON_MAP.get(icon, icon)
            forecast.append(f"{hour_int:02d} {icon} {hour['tempC']}C {desc(hour)}")
    data["tooltip"] = "\n".join([detail, *forecast])

    return json.dumps(data)


if __name__ == "__main__":
    try:
        location = sys.argv[1]
    except IndexError:
        location = ""

    print(weather(location))


class WeatherDesc(TypedDict):
    weatherDesc: list[dict[str, str]]
