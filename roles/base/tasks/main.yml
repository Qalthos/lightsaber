---
- name: Refresh public keys
  ansible.posix.authorized_key:
    user: "{{ ansible_user }}"
    key: https://github.com/qalthos.keys

- name: Transfer dotfiles
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: ~/.{{ item }}
    mode: preserve
  tags:
    - dotfiles
  loop:
    - gitconfig
    - profile
    - zshrc
    - zprofile

- name: Copy config files
  ansible.builtin.include_tasks: copy_filetree.yaml
  loop:
    - config
    - zsh
  tags:
    - dotfiles

- name: Enable en_US.UTF-8 locale
  become: true
  community.general.locale_gen:
    name: en_US.UTF-8
    state: present
  when: ansible_os_family != 'RedHat'

- name: Add mise copr repo
  community.general.copr:
    name: jdxcode/mise
    state: enabled
  become: true
  when: ansible_os_family == "RedHat" and ansible_pkg_mgr != "atomic_container"

- name: Install required environment tools
  become: true
  ansible.builtin.package:
    name:
      - git
      - htop
      - uv
      - mise
      - neovim
      - zsh
    state: present
  when: ansible_pkg_mgr != "atomic_container"

- name: Install gh cli (Arch)
  ansible.builtin.package:
    name:
      - base-devel
      - github-cli
    state: installed
  become: true
  when: ansible_os_family == "Archlinux"

- name: Install gh cli (Red Hat)
  ansible.builtin.package:
    name:
      - gh
    state: installed
  become: true
  when: ansible_os_family == "RedHat" and ansible_pkg_mgr != "atomic_container"

- name: Install uv tools
  ansible.builtin.command:
    cmd: uv tool install {{ item }}
  register: base_uv
  loop:
    - pyrefly
    - ruff
  changed_when:
    - '"is already installed" not in base_uv.stdout'

- name: Set shell to zsh
  become: true
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    shell: /usr/bin/zsh
  when: ansible_os_family != "RedHat"
